<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Foreign Aid Visualization</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  :root {
    --bg: #ffffff;
    --panel: #f8f9fa;
    --text: #111111;
    --muted: #555555;
    --border: #dcdcdc;
    --accent: #2563eb;
  }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 14px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  h1, h3 { margin: 6px 0 10px; font-weight: 600; }
  .wrap {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    padding: 16px;
  }
  @media(max-width:900px){ .wrap{grid-template-columns:1fr} }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  label { font-weight: 600; display:block; margin:10px 0 6px }
  input[type="file"], input[type="text"], input[type="range"], .btn {
    border:1px solid var(--border);
    border-radius:8px;
    padding:8px 10px;
    font-size:14px;
  }
  input[type="file"], input[type="text"], input[type="range"] {
    width:100%;
    background:#fff;
    color:var(--text);
  }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .btn {
    background:#fff;
    cursor:pointer;
    transition: all .15s;
  }
  .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  .btn:hover { background:#f1f5f9 }
  .btn.primary:hover { background:#1d4ed8 }
  #map { width:100%; height:440px; display:block; background:#eef2f7; border-radius:8px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
  th,td { padding:8px 10px; border-bottom:1px solid #e5e7eb; }
  th { background:#f1f5f9; text-align:left; font-weight:600; }
  tr:nth-child(even){ background:#fafafa; }
  tr:hover{ background:#f0f9ff; }
  .hint { color:var(--muted); font-size:12px }
  #tooltip {
    position:fixed; pointer-events:none;
    background:#fff; color:#111; padding:8px 10px;
    border-radius:6px; font-size:13px;
    display:none; box-shadow:0 4px 12px rgba(0,0,0,0.15);
  }
</style>
</head>
<body>
  <div style="padding:14px 18px; border-bottom:1px solid var(--border); background:#f8fafc">
    <h1>Foreign Aid Visualization</h1>
    <div class="hint">Data: OWID / OECD (constant 2022 USD). Upload CSV if auto-load fails.</div>
  </div>

  <div class="wrap">
    <!-- Control Panel -->
    <aside class="panel">
      <label>CSV Input</label>
      <div class="row">
        <input id="fileInput" type="file" accept=".csv" />
        <button id="reloadBtn" class="btn">Reload</button>
      </div>
      <div id="loadHint" class="hint" style="margin-top:8px">
        Trying auto-load from <code>foreign-aid-given-net.csv</code>.
      </div>

      <label>Year</label>
      <div class="row">
        <input id="yearRange" type="range" min="1960" max="2025" step="1" value="2023" />
        <div id="yearLabel" style="width:68px; text-align:center">—</div>
      </div>

      <label>Search Country</label>
      <input id="countrySearch" type="text" placeholder="Korea, United States, JPN…" />

      <div class="row" style="margin-top:8px">
        <button id="resetBtn" class="btn">Reset</button>
        <button id="top10Btn" class="btn">Top 10</button>
      </div>
    </aside>

    <!-- Main Panel -->
    <main class="panel">
      <h3>World Map — Selected Year</h3>
      <svg id="map" viewBox="0 0 800 440" preserveAspectRatio="xMidYMid meet"></svg>

      <h3 style="margin-top:16px">Country Table</h3>
      <div id="tableWrap" style="max-height:300px; overflow:auto"></div>
    </main>
  </div>

  <div id="tooltip"></div>

<script>
(async function(){
  const LOCAL_CSV = "foreign-aid-given-net.csv";
  const GEOJSON_URL = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";

  const $ = sel => document.querySelector(sel);
  const yearRange = $("#yearRange"), yearLabel=$("#yearLabel");
  const tableWrap=$("#tableWrap"), tooltip=d3.select("#tooltip");

  let rows=[], columns=[], numericCol=null;
  let geojson=null, years=[], dataByYear=new Map(), countryLookup=new Map();

  // load CSV
  async function loadCsv(auto=true){
    try{
      let text;
      if(auto){
        const r=await fetch(LOCAL_CSV,{cache:"no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        text=await r.text();
      }else{
        const f=$("#fileInput").files[0];
        text=await f.text();
      }
      parseCsv(text);
    }catch(err){
      console.error(err);
      $("#loadHint").textContent="CSV auto-load failed. Please upload manually.";
    }
  }

  function parseCsv(text){
    rows=d3.csvParse(text);
    columns=rows.columns;
    numericCol=columns.filter(c=>!["Entity","Code","Year"].includes(c)).at(-1);
    rows.forEach(r=>{ r.Year=+r.Year; r.Value=+(r[numericCol]||NaN); });
    years=Array.from(new Set(rows.map(r=>r.Year))).sort((a,b)=>a-b);
    dataByYear=new Map();
    rows.forEach(r=>{
      if(!dataByYear.has(r.Year)) dataByYear.set(r.Year,new Map());
      dataByYear.get(r.Year).set(r.Code.toUpperCase(),r.Value);
      countryLookup.set(r.Code.toUpperCase(),r.Entity);
    });
    yearRange.min=years[0]; yearRange.max=years.at(-1); yearRange.value=years.at(-1);
    yearLabel.textContent=yearRange.value;
    if(!geojson) loadGeo();
    else updateAll();
  }

  async function loadGeo(){
    const r=await fetch(GEOJSON_URL); geojson=await r.json();
    updateAll();
  }

  function updateAll(){
    const year=+yearRange.value; yearLabel.textContent=year;
    renderMap(year); renderTable(year);
  }

  function renderTable(year){
    const mapY=dataByYear.get(year)||new Map();
    const arr=Array.from(countryLookup.entries()).map(([c,n])=>({code:c,name:n,value:mapY.get(c)}));
    arr.sort((a,b)=>(b.value||0)-(a.value||0));
    tableWrap.innerHTML="";
    const table=document.createElement("table");
    table.innerHTML=`<thead><tr><th>#</th><th>Country</th><th>Code</th><th style="text-align:right">Value</th></tr></thead>`;
    const tb=document.createElement("tbody");
    arr.forEach((d,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${d.name}</td><td>${d.code}</td><td style="text-align:right">${isFinite(d.value)?d3.format(",")(d.value):"-"}</td>`;
      tb.appendChild(tr);
    });
    table.appendChild(tb); tableWrap.appendChild(table);
  }

  function renderMap(year){
    if(!geojson) return;
    const mapY=dataByYear.get(year)||new Map();
    const values=Array.from(mapY.values()).filter(v=>isFinite(v)&&v>0);
    const color=d3.scaleSequential(d3.interpolateBlues).domain([Math.log1p(d3.min(values)||1),Math.log1p(d3.max(values)||10)]);
    const projection=d3.geoNaturalEarth1().fitSize([800,440],geojson);
    const path=d3.geoPath(projection);
    const svg=d3.select("#map"); svg.selectAll("*").remove();
    svg.append("g").selectAll("path").data(geojson.features).join("path")
      .attr("d",path)
      .attr("fill",f=>{
        const iso=(f.properties.ISO_A3||"").toUpperCase();
        const val=mapY.get(iso);
        return isFinite(val)&&val>0?color(Math.log1p(val)):"#e5e7eb";
      })
      .attr("stroke","#555").attr("stroke-width",0.4)
      .on("mousemove",(ev,f)=>{
        const iso=(f.properties.ISO_A3||"").toUpperCase();
        const name=f.properties.ADMIN||countryLookup.get(iso)||iso;
        const val=mapY.get(iso);
        tooltip.style("display","block").style("left",(ev.pageX+12)+"px").style("top",(ev.pageY+12)+"px")
          .html(`<strong>${name}</strong><br/>${iso}: ${isFinite(val)?d3.format(",")(val):"no data"}`);
      })
      .on("mouseout",()=>tooltip.style("display","none"));
  }

  // UI events
  yearRange.addEventListener("input",updateAll);
  $("#reloadBtn").addEventListener("click",()=>location.reload());
  $("#fileInput").addEventListener("change",()=>loadCsv(false));

  loadCsv(true);
})();
</script>
</body>
</html>

